// API Scheduling - Exemplos de RequisiÃ§Ãµes e Respostas

/**
 * 1. GET /api/schedules/available-times
 * 
 * ObtÃ©m lista de horÃ¡rios disponÃ­veis para um serviÃ§o em uma data especÃ­fica
 */

// RequisiÃ§Ã£o
GET /api/schedules/available-times?serviceId=service-1&date=2026-02-20

// Respostas

// âœ… Sucesso - HorÃ¡rios disponÃ­veis
HTTP 200 OK
{
  "availableTimes": [
    { "time": "09:00", "timestamp": 1740057600000 },
    { "time": "09:30", "timestamp": 1740059400000 },
    { "time": "10:00", "timestamp": 1740061200000 },
    { "time": "10:30", "timestamp": 1740063000000 },
    { "time": "14:00", "timestamp": 1740076800000 },
    { "time": "14:30", "timestamp": 1740078600000 }
  ],
  "serviceName": "Consulta MÃ©dica",
  "durationMins": 30
}

// âœ… Sucesso - Nenhum horÃ¡rio disponÃ­vel
HTTP 200 OK
{
  "availableTimes": [],
  "message": "Sem disponibilidade para este dia",
  "serviceName": "Consulta MÃ©dica",
  "durationMins": 30
}

// âŒ Erro - ParÃ¢metros invÃ¡lidos
HTTP 400 Bad Request
{
  "error": "serviceId e date sÃ£o obrigatÃ³rios"
}

// âŒ Erro - Data invÃ¡lida
HTTP 400 Bad Request
{
  "error": "Data invÃ¡lida"
}

// âŒ Erro - Data no passado
HTTP 400 Bad Request
{
  "error": "NÃ£o Ã© possÃ­vel agendar para datas passadas"
}

// âŒ Erro - ServiÃ§o nÃ£o encontrado
HTTP 404 Not Found
{
  "error": "ServiÃ§o nÃ£o encontrado"
}

/**
 * 2. POST /api/schedules/create-validated
 * 
 * Cria um novo agendamento com REVALIDAÃ‡ÃƒO de disponibilidade
 */

// RequisiÃ§Ã£o
POST /api/schedules/create-validated
Content-Type: application/json

{
  "serviceId": "service-1",
  "date": "2026-02-20",
  "time": "09:30",
  "guestName": "JoÃ£o Silva",
  "guestEmail": "joao@example.com",
  "guestPhone": "(11) 99999-9999",
  "notes": "Primeira consulta",
  "employeeId": "user-123" // opcional
}

// Respostas

// âœ… Sucesso - Agendamento criado
HTTP 201 Created
{
  "success": true,
  "schedule": {
    "id": "clu8qh2ov0000qrh7z8z8z8z8",
    "startAt": "2026-02-20T09:30:00.000Z",
    "endAt": "2026-02-20T10:00:00.000Z",
    "serviceName": "Consulta MÃ©dica",
    "priceCents": 15000
  }
}

// âŒ Erro - HorÃ¡rio nÃ£o estÃ¡ mais disponÃ­vel (race condition)
HTTP 409 Conflict
{
  "error": "HorÃ¡rio nÃ£o estÃ¡ mais disponÃ­vel",
  "availableAfter": "2026-02-20T10:00:00.000Z"
}

// âŒ Erro - Entrada invÃ¡lida
HTTP 400 Bad Request
{
  "error": "serviceId, date e time sÃ£o obrigatÃ³rios"
}

// âŒ Erro - Email obrigatÃ³rio
HTTP 401 Unauthorized
{
  "error": "Email obrigatÃ³rio"
}

// âŒ Erro - Data invÃ¡lida
HTTP 400 Bad Request
{
  "error": "Data invÃ¡lida"
}

// âŒ Erro - HorÃ¡rio no passado
HTTP 400 Bad Request
{
  "error": "HorÃ¡rio nÃ£o pode estar no passado"
}

// âŒ Erro - ServiÃ§o nÃ£o encontrado
HTTP 404 Not Found
{
  "error": "ServiÃ§o nÃ£o encontrado"
}

/**
 * 3. POST /api/webhooks/schedules
 * 
 * Webhook para confirmar ou cancelar agendamento apÃ³s pagamento
 */

// RequisiÃ§Ã£o - CONFIRMAR apÃ³s pagamento aprovado
POST /api/webhooks/schedules
Content-Type: application/json

{
  "scheduleId": "clu8qh2ov0000qrh7z8z8z8z8",
  "orderId": "order-123",
  "paymentStatus": "PAID",
  "action": "CONFIRM"
}

// Respostas

// âœ… Sucesso - Agendamento confirmado
HTTP 200 OK
{
  "success": true,
  "message": "Agendamento confirmado",
  "schedule": {
    "id": "clu8qh2ov0000qrh7z8z8z8z8",
    "status": "CONFIRMED",
    "startAt": "2026-02-20T09:30:00.000Z",
    "serviceName": "Consulta MÃ©dica",
    "confirmationCode": "CLU8QH2O"
  }
}

// RequisiÃ§Ã£o - CANCELAR apÃ³s pagamento falhar
POST /api/webhooks/schedules
Content-Type: application/json

{
  "scheduleId": "clu8qh2ov0000qrh7z8z8z8z8",
  "paymentStatus": "CANCELLED",
  "action": "CANCEL"
}

// âœ… Sucesso - Agendamento cancelado
HTTP 200 OK
{
  "success": true,
  "message": "Agendamento cancelado",
  "schedule": {
    "id": "clu8qh2ov0000qrh7z8z8z8z8",
    "status": "CANCELLED"
  }
}

// âŒ Erro - AÃ§Ã£o invÃ¡lida
HTTP 400 Bad Request
{
  "error": "action deve ser CONFIRM ou CANCEL"
}

// âŒ Erro - Agendamento nÃ£o encontrado
HTTP 404 Not Found
{
  "error": "Agendamento nÃ£o encontrado"
}

/**
 * 4. PUT /api/webhooks/schedules
 * 
 * Resincronia de estado - valida agendamento e sincroniza com Order
 */

// RequisiÃ§Ã£o
PUT /api/webhooks/schedules
Content-Type: application/json

{
  "scheduleId": "clu8qh2ov0000qrh7z8z8z8z8"
}

// Respostas

// âœ… Sucesso - Agendamento sincronizado
HTTP 200 OK
{
  "success": true,
  "message": "Agendamento sincronizado e confirmado"
}

// âœ… Sucesso - Estado jÃ¡ correto
HTTP 200 OK
{
  "success": true,
  "message": "Agendamento jÃ¡ estÃ¡ em estado correto",
  "schedule": {
    "id": "clu8qh2ov0000qrh7z8z8z8z8",
    "status": "CONFIRMED",
    "paymentStatus": "PAID"
  }
}

// âŒ Erro - Schedule nÃ£o encontrado
HTTP 404 Not Found
{
  "error": "Agendamento nÃ£o encontrado"
}

/**
 * ğŸ“Š Exemplo de Flow Completo
 * 
 * Timeline de um agendamento desde inÃ­cio atÃ© confirmaÃ§Ã£o
 */

/*
T0: UsuÃ¡rio seleciona "Consulta MÃ©dica"
    serviceId = "service-1"

T1: UsuÃ¡rio seleciona data "2026-02-20"
    GET /api/schedules/available-times?serviceId=service-1&date=2026-02-20
    Response: [ "09:00", "09:30", "10:00", ... ]

T2: UsuÃ¡rio seleciona hora "09:30"
    Preenche dados pessoais

T3: UsuÃ¡rio clica "Confirmar"
    POST /api/schedules/create-validated
    Body: {
      serviceId: "service-1",
      date: "2026-02-20",
      time: "09:30",
      guestName: "JoÃ£o",
      guestEmail: "joao@email.com",
      guestPhone: "(11)99999-9999"
    }
    
    Backend:
    â”œâ”€ Revalida: "NinguÃ©m criou agendamento em 09:30?" âœ“
    â”œâ”€ Cria: Schedule { status: PENDING, paymentStatus: PENDING }
    â””â”€ Response: { schedule: { id: "clu8qh2ov..." } }

T4: Frontend redireciona para checkout
    router.push("/checkout/payment?scheduleId=clu8qh2ov...")

T5: UsuÃ¡rio completa pagamento no MercadoPago

T6: MercadoPago envia webhook confirmando pagamento
    MP -> API/checkout -> detecta PAID
    Chama: POST /api/webhooks/schedules
    {
      scheduleId: "clu8qh2ov...",
      paymentStatus: "PAID",
      action: "CONFIRM"
    }
    
    Backend:
    â”œâ”€ Encontra Schedule
    â”œâ”€ Atualiza: status = CONFIRMED, paymentStatus = PAID
    â”œâ”€ Envia email confirmaÃ§Ã£o (TODO)
    â”œâ”€ Notifica funcionÃ¡rio (TODO)
    â””â”€ Response: { success: true }

T7: âœ… Agendamento CONFIRMADO e PAGO!
    UsuÃ¡rio recebe email com detalhes
    FuncionÃ¡rio recebe notificaÃ§Ã£o
*/

/**
 * ğŸ” Casos de Erro e Edge Cases
 */

// Edge Case 1: Race Condition - Dois usuÃ¡rios tentam marcar mesmo horÃ¡rio
// T1: UsuÃ¡rio A solicita horÃ¡rios para 2026-02-20
// T2: UsuÃ¡rio B solicita horÃ¡rios para 2026-02-20
// T3: UsuÃ¡rio A cria agendamento em 09:30 âœ“
// T4: UsuÃ¡rio B tenta criar agendamento em 09:30
// â†’ Response: 409 Conflict "HorÃ¡rio nÃ£o estÃ¡ mais disponÃ­vel"
// â†’ B precisa escolher outro horÃ¡rio

// Edge Case 2: Pagamento falha/Ã© cancelado
// Backend recebe: { action: "CANCEL", paymentStatus: "FAILED" }
// â†’ Schedule.status = CANCELLED
// â†’ HorÃ¡rio volta a ficar disponÃ­vel
// â†’ Email de cancelamento enviado

// Edge Case 3: Webhook duplicado
// MercadoPago pode enviar webhook 2x (idempotÃªncia)
// â†’ PUT /webhooks/schedules detecta estado correto
// â†’ Retorna sucesso (nÃ£o cria agendamento duplicado)

// Edge Case 4: ServiÃ§o desativado
// Service.active = false
// â†’ GET available-times retorna 404
// â†’ POST create-validated retorna 404
// â†’ UsuÃ¡rio nÃ£o consegue agendar

// Edge Case 5: Data muito longe no futuro
// CalendÃ¡rio permite atÃ© 60 dias
// â†’ Se data > 60 dias: pode adicionar validaÃ§Ã£o
// â†’ Exibir mensagem: "Agendamentos disponÃ­veis atÃ© 60 dias"
