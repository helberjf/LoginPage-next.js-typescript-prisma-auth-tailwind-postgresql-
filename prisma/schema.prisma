generator client {
  provider = "prisma-client-js"
  runtime  = "vercel-edge"
}

datasource db {
  provider = "postgresql"
}

////////////////////
// ENUMS
////////////////////

enum Role {
  ADMIN
  STAFF
  CUSTOMER
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  BOLETO
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  REFUNDED
}

////////////////////
// USER (SINGLE-TENANT)
// One deployment = one company
////////////////////

model User {
  id        String   @id @default(cuid())

  // Auth.js standard fields
  name      String?
  email     String?  @unique
  image     String?
  emailVerified DateTime?

  // Local auth / business
  password  String?
  cpf       String?
  role      Role     @default(CUSTOMER)

  // Relations
  orders    Order[]
  accounts  Account[]
  sessions  Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([email])
  @@index([cpf])
}


////////////////////
// PRODUCT
////////////////////

model Product {
  id          String   @id @default(cuid())

  name        String
  description String
  priceCents  Int
  stock       Int      @default(0)
  active      Boolean  @default(true)

  images      ProductImage[]
  orderItems  OrderItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  @@index([active])
}

////////////////////
// PRODUCT IMAGES (MAX 3 PER PRODUCT)
////////////////////

model ProductImage {
  id        String @id @default(cuid())
  productId String
  url       String
  position  Int   // 1, 2, 3

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, position])
}

////////////////////
// ORDER
////////////////////

model Order {
  id            String       @id @default(cuid())

  userId        String?
  user          User?        @relation(fields: [userId], references: [id])

  // Guest checkout fields
  guestFullName String?
  guestEmail    String?
  guestCpf      String?
  guestPhone    String?

  status        OrderStatus  @default(PENDING)
  totalCents    Int
  currency      String       @default("BRL")

  items         OrderItem[]
  payments      Payment[]

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?

  @@index([status])
  @@index([createdAt])
  @@index([guestEmail])
  @@index([userId])
}

////////////////////
// ORDER ITEM
////////////////////

model OrderItem {
  id          String @id @default(cuid())
  orderId     String
  productId   String

  quantity    Int
  priceCents  Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

////////////////////
// PAYMENT (MERCADO PAGO)
////////////////////

model Payment {
  id            String @id @default(cuid())

  orderId       String
  method        PaymentMethod
  status        PaymentStatus

  mpPaymentId   String?
  amountCents   Int
  rawPayload    Json?

  order         Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([mpPaymentId])
}

////////////////////
// NEXTAUTH
////////////////////

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

////////////////////
// WEBHOOK EVENTS (IDEMPOTENCY)
////////////////////

model WebhookEvent {
  id          String   @id @default(cuid())
  providerId  String?
  payload     Json

  processed   Boolean  @default(false)
  processedAt DateTime?
  createdAt   DateTime @default(now())

  @@index([providerId])
}
